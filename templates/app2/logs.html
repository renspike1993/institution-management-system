<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Scanner Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .fade-in {
            animation: fadeInUp 0.3s ease-out;
        }
        
        .scanning-pulse {
            animation: pulse 1s infinite;
        }
        
        /* Keep scanner input invisible */
        #scannerInput {
            opacity: 0;
            position: absolute;
            left: -1000px;
            top: -1000px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <!-- Header -->
    <header class="bg-gradient-to-br from-blue-900 to-blue-800 text-white sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-3">
            {% if request.user.is_superuser %}
            <a href="{% url 'dashboard' %}" class="absolute left-4 top-4 text-blue-200 hover:text-white transition-colors text-sm font-medium">
                ‚Üê Back to Administrator
            </a>
            {% endif %}
            
            <div class="flex flex-col md:flex-row md:items-center md:justify-between max-w-4xl mx-auto">
                <h1 class="text-xl font-semibold text-center md:text-left mb-2 md:mb-0">Attendance [IN]</h1>
                
                <div class="flex justify-center space-x-6">
                    <div class="text-center">
                        <div id="totalScans" class="text-2xl font-bold">0</div>
                        <div class="text-blue-200 text-sm">Total Scans</div>
                    </div>
                    <div class="text-center">
                        <div id="todayScans" class="text-2xl font-bold">0</div>
                        <div class="text-blue-200 text-sm">Today</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-4xl">
        <div id="scanList">
            <!-- Empty State -->
            <div class="empty-state text-center py-16 px-4">
                <div class="text-6xl mb-4 text-gray-300">üì¶</div>
                <div class="text-xl text-gray-600 font-medium mb-2">No scans yet</div>
                <div class="text-gray-500">Start scanning RFID tags to see them here</div>
            </div>
        </div>
    </main>

    <!-- Scanner Status -->
    <div class="fixed bottom-6 right-6 bg-white rounded-full shadow-lg px-4 py-2 flex items-center space-x-2 z-40">
        <div id="statusIndicator" class="w-3 h-3 rounded-full bg-green-500"></div>
        <span id="statusText" class="text-sm font-medium text-gray-700">Ready to scan</span>
    </div>

    <!-- Hidden Scanner Input -->
    <input type="text" 
           id="scannerInput" 
           placeholder="Scan your RFID..." 
           autofocus 
           class="opacity-0 absolute -left-full -top-full">

    <script>
        // Element references
        const input = document.getElementById("scannerInput");
        const scanList = document.getElementById("scanList");
        const totalScansElement = document.getElementById("totalScans");
        const todayScansElement = document.getElementById("todayScans");
        const statusIndicator = document.getElementById("statusIndicator");
        const statusText = document.getElementById("statusText");

        // State variables
        let totalScans = 0;
        let todayScans = 0;
        let scanHistory = [];
        let scanTimeout = null;
        let currentScan = "";

        // Scanner configuration
        const SCANNER_DELAY = 100;
        const MIN_SCAN_LENGTH = 3;

        // Focus management
        input.addEventListener("blur", () => {
            setTimeout(() => input.focus(), 10);
        });

        // Scanner input handling
        input.addEventListener("input", (e) => {
            currentScan = input.value;
            updateScannerStatus("scanning", "Scanning...");

            if (scanTimeout) {
                clearTimeout(scanTimeout);
            }

            scanTimeout = setTimeout(() => {
                processScan(currentScan);
                input.value = "";
                currentScan = "";
            }, SCANNER_DELAY);
        });

        // Enter key fallback
        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && input.value.trim() !== "") {
                if (scanTimeout) {
                    clearTimeout(scanTimeout);
                }
                processScan(input.value.trim());
                input.value = "";
                currentScan = "";
            }
        });

        // Audio functions
        function alertBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();

            function beep(freq, duration, delay = 0) {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.type = "sawtooth";
                    osc.frequency.value = freq;
                    gain.gain.value = 0.7;

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.start();
                    setTimeout(() => osc.stop(), duration);
                }, delay);
            }

            beep(1200, 200, 0);
            beep(1200, 200, 300);
            beep(1200, 400, 600);
        }

        function successBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();

            function tone(freq, duration, delay = 0) {
                setTimeout(() => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();

                    osc.type = "sine";
                    osc.frequency.value = freq;
                    gain.gain.value = 0.4;

                    osc.connect(gain);
                    gain.connect(ctx.destination);

                    osc.start();
                    setTimeout(() => osc.stop(), duration);
                }, delay);
            }

            tone(800, 120, 0);
            tone(1200, 150, 180);
        }

        function speak(text) {
            speechSynthesis.cancel();
            const speech = new SpeechSynthesisUtterance(text);
            speech.lang = "en-US";
            speech.rate = 1;
            speech.pitch = 1;
            speech.volume = 1;
            speechSynthesis.speak(speech);
        }

        // Scan processing
        function shouldTriggerUnauthorized(scanValue) {
            const scans = JSON.parse(localStorage.getItem("scanHistory")) || {};
            const now = Date.now();

            if (scans[scanValue]) {
                const lastTime = scans[scanValue];
                const diff = (now - lastTime) / 1000;

                if (diff >= 3) {
                    scans[scanValue] = now;
                    localStorage.setItem("scanHistory", JSON.stringify(scans));
                    return true;
                } else {
                    return false;
                }
            }

            scans[scanValue] = now;
            localStorage.setItem("scanHistory", JSON.stringify(scans));
            return false;
        }

        function processScan(value) {
            if (value.length < MIN_SCAN_LENGTH) {
                showStatus("error", "Invalid scan (too short)");
                return;
            }

            showStatus("scanning", "Checking book...");

            fetch(`/library/api/check-book/${value}/`)
                .then((response) => response.json())
                .then((data) => {
                    switch (data.status) {
                        case "available":
                            if (shouldTriggerUnauthorized(value)) {
                                addScanItem({
                                    id: Date.now(),
                                    value: value + "üìï",
                                    title: "üìï Unauthorized" + data.book_title,
                                    status: "üìï Unauthorized",
                                    extra: `Borrower: ${data.borrower}<br>Date: ${data.date_borrowed}`,
                                    timestamp: new Date(),
                                    time: new Date().toLocaleTimeString(),
                                    date: new Date().toLocaleDateString(),
                                });
                                speak("Stop!");
                                showAlert("error", "Unauthorized to checkout!", `"${data.book_title}" <br> This book is not authorized to go out!`, 3000);
                                alertBeep();
                                updateScannerStatus("error", "Book is borrowed");
                            }
                            break;

                        case "borrowed":
                            if (shouldTriggerUnauthorized(value)) {
                                addScanItem({
                                    id: Date.now(),
                                    value: "‚úÖ " + value,
                                    title: data.book_title,
                                    status: "‚úÖ Borrowed",
                                    extra: `Borrower: ${data.borrower}<br>Date: ${data.date_borrowed}`,
                                    timestamp: new Date(),
                                    time: new Date().toLocaleTimeString(),
                                    date: new Date().toLocaleDateString(),
                                });
                                showAlert("success", "Authorized to checkout!", `"${data.book_title}" <br> Borrowed by: ${data.borrower} <br> Date: ${data.date_borrowed}`);
                                successBeep();
                                updateScannerStatus("error", "Book is borrowed");
                            }
                            break;

                        case "not_found":
                            showAlert("error", "Not Found", `Barcode "${value}" not found`);
                            showStatus("error", "Barcode not found");
                            break;
                    }

                    setTimeout(() => showStatus("ready", "Ready to scan"), 1500);
                })
                .catch(() => {
                    showStatus("error", "Server error");
                    setTimeout(() => showStatus("ready", "Ready to scan"), 1500);
                });

            input.value = "";
        }

        // Alert and status helpers
        function showAlert(icon, title, html) {
            Swal.fire({
                icon: icon,
                title: title,
                html: html,
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                allowOutsideClick: false,
            });
        }

        function showStatus(status, text) {
            statusIndicator.className = "w-3 h-3 rounded-full";
            statusText.textContent = text;

            switch (status) {
                case "ready":
                    statusIndicator.classList.add("bg-green-500");
                    break;
                case "scanning":
                    statusIndicator.classList.add("bg-orange-500", "scanning-pulse");
                    break;
                case "success":
                    statusIndicator.classList.add("bg-green-500");
                    break;
                case "error":
                    statusIndicator.classList.add("bg-red-500");
                    break;
            }
        }

        function updateScannerStatus(status, text) {
            statusIndicator.className = "w-3 h-3 rounded-full";
            statusText.textContent = text;

            switch (status) {
                case "ready":
                    statusIndicator.classList.add("bg-green-500");
                    break;
                case "scanning":
                    statusIndicator.classList.add("bg-orange-500", "scanning-pulse");
                    break;
                case "success":
                    statusIndicator.classList.add("bg-green-500");
                    break;
                case "error":
                    statusIndicator.classList.add("bg-red-500");
                    break;
            }
        }

        // Update statistics
        function updateStats() {
            totalScansElement.textContent = totalScans;
            todayScansElement.textContent = todayScans;
        }

        // Add scan item to list
        function addScanItem(scan) {
            // Remove empty state if present
            const emptyState = scanList.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Generate color based on RFID value
            const colorIndex = hashCode(scan.value) % 5;
            const colors = ["bg-blue-100", "bg-green-100", "bg-red-100", "bg-orange-100", "bg-purple-100"];
            const textColors = ["text-blue-800", "text-green-800", "text-red-800", "text-orange-800", "text-purple-800"];
            const borderColors = ["border-blue-200", "border-green-200", "border-red-200", "border-orange-200", "border-purple-200"];

            const card = document.createElement("div");
            card.classList.add("fade-in", "bg-white", "rounded-xl", "shadow-md", "border", borderColors[colorIndex], "mb-4", "overflow-hidden", "transition-transform", "duration-200", "hover:shadow-lg");
            
            card.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full ${colors[colorIndex]} flex items-center justify-center ${textColors[colorIndex]} font-bold">
                                ${scan.value.charAt(0)}
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-gray-800">RFID Scan</h3>
                                    <p class="text-sm text-gray-500">${scan.date} at ${scan.time}</p>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${scan.status.includes('‚úÖ') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${scan.status}
                                </span>
                            </div>
                            
                            <div class="mt-3">
                                <p class="text-gray-700">
                                    <span class="font-medium">Scanned RFID:</span> 
                                    <span class="font-mono bg-gray-50 px-2 py-1 rounded">${scan.value}</span>
                                </p>
                                ${scan.extra ? `<div class="mt-2 text-sm text-gray-600">${scan.extra}</div>` : ''}
                            </div>
                            
                            <div class="mt-4 flex justify-between items-center text-sm text-gray-500">
                                <span>ID: ${scan.id}</span>
                                <span>${getTimeAgo(scan.timestamp)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex space-x-2">
                    <button class="action-btn px-3 py-1.5 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                        <span>‚úì</span> Validate
                    </button>
                    <button class="action-btn px-3 py-1.5 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                        <span>‚ÑπÔ∏è</span> Details
                    </button>
                    <button class="delete-btn px-3 py-1.5 text-sm font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors ml-auto">
                        <span>üóëÔ∏è</span> Delete
                    </button>
                </div>
            `;

            scanList.prepend(card);
            totalScans++;
            updateStats();

            // Add delete functionality
            const deleteBtn = card.querySelector(".delete-btn");
            deleteBtn.addEventListener("click", () => {
                card.style.opacity = "0";
                card.style.transform = "translateX(-100px)";
                setTimeout(() => {
                    card.remove();
                    totalScans--;
                    updateStats();

                    if (scanList.children.length === 0) {
                        showEmptyState();
                    }
                }, 300);
            });
        }

        // Show empty state
        function showEmptyState() {
            const emptyState = document.createElement("div");
            emptyState.className = "empty-state text-center py-16 px-4";
            emptyState.innerHTML = `
                <div class="text-6xl mb-4 text-gray-300">üì¶</div>
                <div class="text-xl text-gray-600 font-medium mb-2">No scans yet</div>
                <div class="text-gray-500">Start scanning RFID tags to see them here</div>
            `;
            scanList.appendChild(emptyState);
        }

        // Helper functions
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = (hash << 5) - hash + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const diffMs = now - timestamp;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return "Just now";
            if (diffMins < 60) return `${diffMins} minute${diffMins === 1 ? "" : "s"} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? "" : "s"} ago`;
            return timestamp.toLocaleDateString();
        }

        // Initialize
        window.addEventListener("load", () => {
            input.focus();
            // Uncomment for sample data
            // addSampleData();
        });

        function addSampleData() {
            const sampleScans = ["RFID-001-ABC123", "RFID-002-XYZ789", "RFID-003-DEF456", "RFID-004-GHI789", "RFID-005-JKL012"];
            sampleScans.forEach((scan, index) => {
                setTimeout(() => {
                    processScan(scan);
                }, index * 300);
            });
        }
    </script>
</body>
</html>